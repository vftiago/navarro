# Development Session - 2025-12-05 18:25

## Session Overview

**Start Time:** 2025-12-05 18:25
**Status:** Active

## Goals

1. Update CLAUDE.md with detailed turn structure and trigger moment compendium
2. Analyze PhaseManager.tsx, App.tsx, playerCards, serverCards, and state folder
3. Identify redundancies, incoherences, and potential points of improvement
4. Document comprehensive game flow and phase transitions

## Progress

### Tasks Completed

- ✅ Session started
- ✅ Analyzed PhaseManager.tsx - understood counter-based phase management system
- ✅ Analyzed App.tsx - identified modal-phase coupling issues
- ✅ Analyzed state folder structure - reviewed all phase implementations
- ✅ Analyzed card definitions (playerCards and serverCards) - examined trigger usage
- ✅ Identified 8 major redundancies, incoherences, and improvement opportunities
- ✅ Documented complete turn structure with detailed phase breakdown
- ✅ Created comprehensive trigger moment compendium
- ✅ Updated CLAUDE.md with all findings
- ✅ Expanded Critical Issue #1 (Main Phase) with detailed solution and code examples
- ✅ Implemented Main Phase handler solution:
  - Created `src/state/phases/mainPhase.ts` with `startMainPhase()` function
  - Updated `src/state/phases/index.ts` to export the new function
  - Updated `src/PhaseManager.tsx` to add Main phase handler
  - All TypeScript and ESLint checks passing
- ✅ Implemented all remaining trigger moments:
  - **Added ON_RUN_START**: Executes in Run phase Start on all installed programs
  - **Implemented ON_RUN_END**: Executes in Run phase End on all installed programs
  - **Implemented ON_INSTALL**: Executes in Play phase End when programs are installed
  - **Implemented ON_DISCARD**: Executes before discarding (Play phase, Access phase, damage)
  - **Implemented ON_TRASH**: Executes before trashing (Play phase End)
  - **Removed ON_REVEAL**: Deleted from TriggerMoment enum (replaced by ON_ACCESS)
  - Created `executeCardTriggers()` helper function in cardUtils.ts
- ✅ Fixed card implementations:
  - "Running Sneakers" - Corrected effect to gain 1 click (was incorrectly setting next phase)
  - "Server Lockdown" - Changed from ON_REVEAL to ON_ACCESS, TurnPhase.Discard to TurnPhase.End
  - "Intrusive Thoughts" - Now works correctly with ON_TURN_START
- ✅ Updated CLAUDE.md documentation:
  - Marked Critical Issues #2 and #3 as resolved
  - Updated Trigger Moment Compendium with all active triggers (13 total)
  - Updated Turn Structure to show when triggers execute
  - Updated Points for Improvement to mark completed items
- ✅ Cleaned up CLAUDE.md:
  - Removed verbose resolved issue documentation
  - Consolidated remaining issues (7 active issues/improvements)
  - Added "Recently Completed" section with session summary
  - Made documentation more concise and actionable
- ✅ Removed unused TurnPhase enum values:
  - Deleted `Start`, `Fetch`, and `Discard` from TurnPhase enum
  - Alphabetized remaining enum values for consistency
  - Updated CLAUDE.md to remove "Unused/Incomplete Phases" section
  - All TypeScript and ESLint checks passing
- ✅ Fixed infinite loop in MainPhase handler:
  - **Root cause**: `startMainPhase()` was calling `setTurnCurrentSubPhase(Start)` which incremented `phaseChangeCounter`, triggering the handler again
  - **Solution**: Removed redundant `setTurnCurrentSubPhase` call - phase is already in Start subphase
  - **Files modified**: `src/state/phases/mainPhase.ts` - removed dispatch call and unused import
  - Infinite render loop resolved

### Key Findings

**Critical Issues Identified:**

1. **Main Phase Missing Handler** - Phase referenced in 3+ locations but no PhaseManager handler exists
2. **Discard Phase Undefined** - "Server Lockdown" trap card sets phase with no handler
3. **5 Unused Trigger Moments** - ON_RUN_END, ON_REVEAL, ON_TRASH, ON_INSTALL, ON_DISCARD defined but never executed

**Inconsistencies:**

4. Subphase pattern violations (Play/Access/Encounter phases have empty or missing handlers)
5. Modal-phase coupling in App.tsx (tight coupling between UI and game state)
6. Copy-paste error in Fire Wall card error message

**Redundancies:**

7. Unused TurnPhase enum values (Start, Fetch never referenced)
8. Keyword effects reference triggers that never execute

### Documentation Added to CLAUDE.md

**Turn Structure & Phase Flow Section** (~150 lines):

- Complete turn cycle diagram
- Detailed breakdown of all 8 phases (Corp, Draw, Main, Play, Run, Encounter, Access, End)
- Phase transition triggers (automatic, manual, card-driven)
- Unused/incomplete phases list

**Trigger Moment Compendium Section** (~100 lines):

- Active triggers (8 total): ON_TURN_START, ON_DRAW, ON_PLAY, ON_ENCOUNTER, ON_REZ, ON_ACCESS, ON_FETCH, ON_CLICK
- Inactive triggers (5 total): ON_RUN_END, ON_REVEAL, ON_TRASH, ON_INSTALL, ON_DISCARD
- Trigger execution pattern with code examples

**Known Issues & Redundancies Section** (~50 lines):

- 3 critical issues
- 3 inconsistencies
- 2 redundancy categories

**Points for Improvement Section** (~60 lines):

- 3 high priority improvements
- 4 medium priority improvements
- 3 low priority improvements

### Notes

- The game uses a counter-based phase change system where PhaseManager watches `phaseChangeCounter` increments
- Main phase is intentionally UI-only with no handlers (acts as waiting state between actions)
- Some phases (Encounter, Access) have user-driven endings via modal interactions
- Card effects can return either actions (simple) or thunks (complex multi-step)
- Several cards have effects that currently don't fire (Running Sneakers, Server Lockdown, etc.)

### Files Analyzed

- `src/PhaseManager.tsx` - Phase orchestration
- `src/App.tsx` - Root component and modal management
- `src/state/turn/types.ts` - Phase/subphase enums
- `src/state/phases/*.ts` - All 7 phase implementations (drawPhase, playPhase, runPhase, encounterPhase, accessPhase, endPhase, corpPhase)
- `src/cardDefinitions/card.ts` - Card types and trigger moments
- `src/cardDefinitions/keywords.ts` - Keyword effects
- `src/cardDefinitions/playerCards/*.ts` - Program and script cards
- `src/cardDefinitions/serverCards/*.ts` - Ice, agenda, and trap cards
- `src/state/utils/cardUtils.ts` - Card effect execution utilities
- `src/state/player/selectors.ts` - Player state selectors

### Files Created/Modified (Implementation)

**Created:**
- `src/state/phases/mainPhase.ts` - New Main phase handler with `startMainPhase()` thunk

**Modified (Part 1 - Main Phase):**
- `src/state/phases/index.ts` - Added export for `startMainPhase`
- `src/PhaseManager.tsx` - Added Main phase handler to `PHASE_HANDLERS` object

**Modified (Part 2 - Trigger Moments):**
- `src/cardDefinitions/card.ts` - Removed `ON_REVEAL`, added `ON_RUN_START`, alphabetized enum
- `src/cardDefinitions/serverCards/traps.ts` - Updated "Server Lockdown" card
- `src/cardDefinitions/playerCards/programs.ts` - Fixed "Running Sneakers" effect, removed unused imports
- `src/state/phases/runPhase.ts` - Added ON_RUN_START and ON_RUN_END trigger execution
- `src/state/phases/playPhase.ts` - Added ON_INSTALL, ON_DISCARD, ON_TRASH trigger execution
- `src/state/phases/accessPhase.ts` - Added ON_DISCARD trigger execution
- `src/state/utils/cardUtils.ts` - Added `executeCardTriggers()` helper function
- `src/state/utils/damageUtils.ts` - Added ON_DISCARD trigger execution for net damage
- `src/state/player/actions.ts` - Removed unused imports

**Modified (Part 3 - Enum Cleanup):**
- `src/state/turn/types.ts` - Removed unused TurnPhase values (Start, Fetch, Discard), alphabetized

### Implementation Details

**Main Phase Handler Behavior:**
1. Executes when transitioning to Main phase (from Draw, Play, or Access phases)
2. Triggers `ON_TURN_START` effects on all installed programs
3. Sets subphase to Start and waits for player input
4. No automatic Process/End transitions (waiting state)

**Fixed Card:**
- "Intrusive Thoughts" (programs.ts:74-87) - `ON_TURN_START` trigger now executes correctly
  - Effect: Draw 1 card and lose 1 click at the beginning of player's action window

**Design Decision:**
- Main phase only has Start subphase handler (no Process/End)
- This makes explicit that Main is a waiting state for player actions
- Consistent with game design where player can take multiple actions during Main phase

**Trigger Moment Implementation Details:**

All trigger moments now properly execute via `executeCardTriggers()` helper:

1. **ON_TURN_START**: Main phase Start - all installed programs
2. **ON_DRAW**: Draw phase Process - all cards in hand
3. **ON_PLAY**: Play phase Process - all played cards
4. **ON_INSTALL**: Play phase End - programs being installed (before adding to programs)
5. **ON_DISCARD**: Multiple locations:
   - Play phase End - non-program, non-trash cards
   - Access phase - when selecting non-agenda cards
   - Damage resolution - cards discarded from hand
6. **ON_TRASH**: Play phase End - cards with Trash keyword
7. **ON_RUN_START**: Run phase Start - all installed programs
8. **ON_RUN_END**: Run phase End - all installed programs
9. **ON_ENCOUNTER**: Encounter phase - current encountered Ice
10. **ON_ACCESS**: Access phase Process - all accessed cards
11. **ON_FETCH**: Access phase - when player selects card
12. **ON_REZ**: Corp phase - newly installed Ice
13. **ON_CLICK**: User-triggered - manual activation (not phase-driven)

**Implementation Pattern**:
- Triggers execute BEFORE the associated action (discard, trash, install)
- This allows cards to react to their own state change
- Helper function `executeCardTriggers(card, moment, dispatch, getState)` standardizes execution
